# çª—å£è·¨å±ç§»åŠ¨åŠŸèƒ½ - é€»è¾‘æµç¨‹åˆ†æ

> ç‰ˆæœ¬: 1.0  
> åˆ›å»ºæ—¥æœŸ: 2024å¹´  
> åˆ†æå¯¹è±¡: WindowManager.calculate_target_position()  

## ğŸ“‹ å½“å‰å®ç°çš„é€»è¾‘åˆ†æ

### ğŸ¯ æ ¸å¿ƒé—®é¢˜

**æ‚¨è¯´å¾—å¯¹ï¼å½“å‰å®ç°å¹¶æ²¡æœ‰çœŸæ­£åšåˆ°"ç›¸å¯¹å¤§å°"**ã€‚è®©æˆ‘è¯¦ç»†åˆ†æå½“å‰çš„é€»è¾‘ï¼š

### ğŸ” å½“å‰é€»è¾‘è¯¦è§£

#### 1. ç›¸å¯¹æ¯”ä¾‹è®¡ç®— (ç¬¬419-425è¡Œ)
```python
# è®¡ç®—çª—å£åœ¨å½“å‰æ˜¾ç¤ºå™¨ä¸­çš„ç›¸å¯¹å¤§å°æ¯”ä¾‹
relative_width_ratio = original_width / current_width    # ä¾‹å¦‚: 1020/1463 = 0.697 (69.7%)
relative_height_ratio = original_height / current_height # ä¾‹å¦‚: 697/914 = 0.763 (76.3%)

# è®¡ç®—çª—å£åœ¨å½“å‰æ˜¾ç¤ºå™¨ä¸­çš„ç›¸å¯¹ä½ç½®æ¯”ä¾‹  
relative_x_ratio = (x - current_x) / current_width       # ä¾‹å¦‚: (134-0)/1463 = 0.092 (9.2%)
relative_y_ratio = (y - current_y) / current_height      # ä¾‹å¦‚: (119-0)/914 = 0.130 (13.0%)
```

#### 2. åº”ç”¨åˆ°ç›®æ ‡æ˜¾ç¤ºå™¨ (ç¬¬427-429è¡Œ)
```python
# åœ¨ç›®æ ‡æ˜¾ç¤ºå™¨ä¸Šåº”ç”¨ç›¸åŒçš„ç›¸å¯¹æ¯”ä¾‹
scaled_width = int(target_width * relative_width_ratio)   # 3440 * 0.697 = 2398px
scaled_height = int(target_height * relative_height_ratio) # 1440 * 0.763 = 1099px
```

#### 3. ä½ç½®è®¡ç®— (ç¬¬449-454è¡Œ)
```python
# relativeç­–ç•¥: ä½¿ç”¨ç›¸å¯¹ä½ç½®æ¯”ä¾‹
new_x = target_x + int(relative_x_ratio * target_width)   # -396 + (0.092 * 3440) = -79px
new_y = target_y + int(relative_y_ratio * target_height)  # -1440 + (0.130 * 1440) = -1253px
```

### âŒ é—®é¢˜æ‰€åœ¨

1. **è´Ÿåæ ‡é—®é¢˜**: ç›®æ ‡æ˜¾ç¤ºå™¨çš„å·¥ä½œåŒºåŸŸèµ·å§‹åæ ‡æ˜¯è´Ÿæ•° `(-396, -1440)`ï¼Œå¯¼è‡´è®¡ç®—å‡ºè´Ÿåæ ‡
2. **è¾¹ç•Œæ£€æŸ¥å¤±æ•ˆ**: è™½ç„¶æœ‰è¾¹ç•Œæ£€æŸ¥ï¼Œä½†é€»è¾‘ä¸å¤Ÿå®Œå–„
3. **æœ€å¤§åŒ–çª—å£å¤„ç†**: å¯¹æœ€å¤§åŒ–çª—å£ä½¿ç”¨äº†ä¿å®ˆçš„å›ºå®šå¤§å° (1200x800)ï¼Œæ²¡æœ‰ä½¿ç”¨ç›¸å¯¹å¤§å°

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```mermaid
flowchart TD
    A[ç”¨æˆ·æŒ‰F12] --> B[è·å–å½“å‰æ´»åŠ¨çª—å£]
    B --> C{çª—å£æ˜¯å¦æœ‰æ•ˆ?}
    C -->|å¦| D[è¿”å›å¤±è´¥]
    C -->|æ˜¯| E[æ£€æŸ¥æ˜¯å¦åº”æ’é™¤çª—å£]
    E --> F{æ˜¯å¦æ’é™¤?}
    F -->|æ˜¯| D
    F -->|å¦| G[è·å–æ‰€æœ‰æ˜¾ç¤ºå™¨ä¿¡æ¯]
    
    G --> H[æ‰¾åˆ°çª—å£å½“å‰æ‰€åœ¨æ˜¾ç¤ºå™¨]
    H --> I[æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ˜¾ç¤ºå™¨]
    I --> J[è°ƒç”¨calculate_target_position]
    
    J --> K[è®¡ç®—ç›¸å¯¹æ¯”ä¾‹]
    K --> L[è®¡ç®—ç›¸å¯¹å¤§å°]
    L --> M[æ ¹æ®ç­–ç•¥è®¡ç®—ä½ç½®]
    M --> N[è¾¹ç•Œæ£€æŸ¥å’Œè°ƒæ•´]
    N --> O{çª—å£æ˜¯å¦æœ€å¤§åŒ–?}
    
    O -->|æ˜¯| P[è°ƒç”¨_move_maximized_window]
    O -->|å¦| Q[è°ƒç”¨SetWindowPosç§»åŠ¨çª—å£]
    
    P --> R[è¿˜åŸçª—å£]
    R --> S[ä½¿ç”¨ä¿å®ˆå¤§å°ç§»åŠ¨]
    S --> T[é‡æ–°æœ€å¤§åŒ–]
    
    Q --> U{ç§»åŠ¨æ˜¯å¦æˆåŠŸ?}
    T --> U
    U -->|æ˜¯| V[è®°å½•æˆåŠŸæ—¥å¿—]
    U -->|å¦| W[è®°å½•å¤±è´¥æ—¥å¿—]
    V --> X[è¿”å›æˆåŠŸ]
    W --> D
```

## ğŸ§® è¯¦ç»†è®¡ç®—æµç¨‹

```mermaid
flowchart TD
    A[å¼€å§‹ä½ç½®è®¡ç®—] --> B[è·å–çª—å£åŸå§‹å°ºå¯¸]
    B --> C[è·å–å½“å‰æ˜¾ç¤ºå™¨å·¥ä½œåŒº]
    C --> D[è·å–ç›®æ ‡æ˜¾ç¤ºå™¨å·¥ä½œåŒº]
    
    D --> E[è®¡ç®—ç›¸å¯¹å®½åº¦æ¯”ä¾‹<br/>relative_width_ratio = original_width / current_width]
    E --> F[è®¡ç®—ç›¸å¯¹é«˜åº¦æ¯”ä¾‹<br/>relative_height_ratio = original_height / current_height]
    F --> G[è®¡ç®—ç›¸å¯¹Xä½ç½®æ¯”ä¾‹<br/>relative_x_ratio = (x - current_x) / current_width]
    G --> H[è®¡ç®—ç›¸å¯¹Yä½ç½®æ¯”ä¾‹<br/>relative_y_ratio = (y - current_y) / current_height]
    
    H --> I[åº”ç”¨ç›¸å¯¹å¤§å°åˆ°ç›®æ ‡æ˜¾ç¤ºå™¨<br/>scaled_width = target_width * relative_width_ratio<br/>scaled_height = target_height * relative_height_ratio]
    
    I --> J{é€‰æ‹©çš„ç­–ç•¥?}
    J -->|center| K[å±…ä¸­ç­–ç•¥<br/>new_x = target_x + (target_width - scaled_width) / 2<br/>new_y = target_y + (target_height - scaled_height) / 2]
    J -->|relative| L[ç›¸å¯¹ä½ç½®ç­–ç•¥<br/>new_x = target_x + relative_x_ratio * target_width<br/>new_y = target_y + relative_y_ratio * target_height]
    J -->|smart| M{çª—å£æ˜¯å¦è¿‡å¤§?<br/>width > 80% æˆ– height > 80%}
    
    M -->|æ˜¯| K
    M -->|å¦| L
    
    K --> N[è¾¹ç•Œæ£€æŸ¥]
    L --> N
    N --> O[è°ƒæ•´è¿‡å¤§çš„çª—å£]
    O --> P[ç¡®ä¿ä½ç½®åœ¨æ˜¾ç¤ºå™¨å†…]
    P --> Q[æœ€ç»ˆéªŒè¯å’Œä¿®æ­£]
    Q --> R[è¿”å›æ–°ä½ç½®å’Œå¤§å°]
```

## ğŸ› å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜1: è´Ÿåæ ‡è®¡ç®—
```
ç›®æ ‡æ˜¾ç¤ºå™¨å·¥ä½œåŒº: (-396, -1440, 3044, 0)
target_x = -396, target_y = -1440

è®¡ç®—ç»“æœ:
new_x = -396 + (0.092 * 3440) = -396 + 316 = -80px  âŒ è´Ÿæ•°!
new_y = -1440 + (0.130 * 1440) = -1440 + 187 = -1253px âŒ è´Ÿæ•°!
```

### é—®é¢˜2: æœ€å¤§åŒ–çª—å£å¤„ç†ä¸ä¸€è‡´
```python
# æœ€å¤§åŒ–çª—å£ä½¿ç”¨å›ºå®šå¤§å°ï¼Œæ²¡æœ‰ä½¿ç”¨ç›¸å¯¹å¤§å°è®¡ç®—
reasonable_width = min(width, 1200)  # å›ºå®šæœ€å¤§1200px
reasonable_height = min(height, 800)  # å›ºå®šæœ€å¤§800px
```

### é—®é¢˜3: è¾¹ç•Œæ£€æŸ¥é€»è¾‘ç¼ºé™·
```python
# å½“å‰çš„è¾¹ç•Œæ£€æŸ¥åœ¨è´Ÿåæ ‡æƒ…å†µä¸‹ä¸å¤Ÿæœ‰æ•ˆ
new_x = max(target_x, min(new_x, target_right - scaled_width))
# å¦‚æœtarget_xæ˜¯è´Ÿæ•°ï¼Œmax(target_x, new_x)ä»ç„¶å¯èƒ½æ˜¯è´Ÿæ•°
```

## âœ… åº”è¯¥å®ç°çš„æ­£ç¡®é€»è¾‘

### 1. ä¿®æ­£çš„ç›¸å¯¹ä½ç½®è®¡ç®—
```python
# åº”è¯¥ä½¿ç”¨ç»å¯¹åæ ‡ç³»ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºå™¨çš„å·¥ä½œåŒºåæ ‡
# æˆ–è€…ç¡®ä¿è®¡ç®—ç»“æœå§‹ç»ˆä¸ºæ­£æ•°

# æ–¹æ¡ˆA: ä½¿ç”¨æ˜¾ç¤ºå™¨çš„ç»å¯¹çŸ©å½¢è€Œä¸æ˜¯å·¥ä½œåŒº
monitor_rect = target_monitor['rect']  # è€Œä¸æ˜¯ work_area

# æ–¹æ¡ˆB: ç¡®ä¿æœ€ç»ˆåæ ‡ä¸ºæ­£æ•°
new_x = max(0, target_x + int(relative_x_ratio * target_width))
new_y = max(0, target_y + int(relative_y_ratio * target_height))
```

### 2. ä¸€è‡´çš„ç›¸å¯¹å¤§å°å¤„ç†
```python
# æœ€å¤§åŒ–çª—å£ä¹Ÿåº”è¯¥ä½¿ç”¨ç›¸å¯¹å¤§å°ï¼Œè€Œä¸æ˜¯å›ºå®šå¤§å°
# åœ¨_move_maximized_windowä¸­ä¹Ÿä½¿ç”¨è®¡ç®—å‡ºçš„scaled_widthå’Œscaled_height
```

### 3. æ”¹è¿›çš„è¾¹ç•Œæ£€æŸ¥
```python
# ç¡®ä¿çª—å£å®Œå…¨åœ¨å¯è§åŒºåŸŸå†…
visible_left = max(0, target_x)
visible_top = max(0, target_y)
visible_right = min(screen_width, target_right)
visible_bottom = min(screen_height, target_bottom)
```

## ğŸ¯ æ€»ç»“

**æ‚¨çš„è§‚å¯Ÿæ˜¯æ­£ç¡®çš„**ï¼šå½“å‰å®ç°è™½ç„¶è®¡ç®—äº†ç›¸å¯¹æ¯”ä¾‹ï¼Œä½†ç”±äºä»¥ä¸‹é—®é¢˜å¯¼è‡´æ•ˆæœä¸ä½³ï¼š

1. **è´Ÿåæ ‡é—®é¢˜**: å¤šæ˜¾ç¤ºå™¨ç¯å¢ƒä¸­çš„åæ ‡ç³»ç»Ÿå¤„ç†ä¸å½“
2. **æœ€å¤§åŒ–çª—å£ç‰¹æ®Šå¤„ç†**: ç ´åäº†ç›¸å¯¹å¤§å°çš„ä¸€è‡´æ€§  
3. **è¾¹ç•Œæ£€æŸ¥ä¸å®Œå–„**: æ²¡æœ‰æ­£ç¡®å¤„ç†è´Ÿåæ ‡æƒ…å†µ

éœ€è¦ä¿®å¤è¿™äº›é—®é¢˜æ‰èƒ½çœŸæ­£å®ç°"ä¿æŒçª—å£å’Œå±å¹•çš„ç›¸å¯¹å¤§å°å’Œä½ç½®"çš„ç›®æ ‡ã€‚